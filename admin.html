<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="description" content="Admin dashboard for managing HawkerHunt SG content">
  <meta name="theme-color" content="#2A6EF0">
  <title>HawkerHunt Admin</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè™ HawkerHunt Admin Dashboard</h1>
      <p>Manage centres, stalls, and reviews</p>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="centres">Hawker Centres</div>
      <div class="tab" data-tab="stalls">Stalls</div>
      <div class="tab" data-tab="reviews">Reviews</div>
    </div>

    <div class="tab-content active" id="centres-tab">
      <div class="card">
        <h2 class="section-title">Add New Hawker Centre</h2>
        <form id="centre-form">
          <label for="centre_id">Centre ID (short, e.g. "chinatown")</label>
          <input type="text" id="centre_id" required>

          <label for="centre_name">Name</label>
          <input type="text" id="centre_name" required>

          <label for="mrt">MRT Station</label>
          <input type="text" id="mrt" required>

          <label for="address">Address</label>
          <input type="text" id="address" required>

          <label for="about">About</label>
          <textarea id="about" rows="3"></textarea>

          <label for="image_url">Image URL</label>
          <input type="text" id="image_url">

          <button type="submit" style="width: 100%;">Add Centre</button>
        </form>
      </div>

      <div class="card">
        <h2 class="section-title">All Centres</h2>
        <div id="centres-list">
          <p>Loading centres...</p>
        </div>
      </div>
    </div>

    <div class="tab-content" id="stalls-tab">
      <div class="card">
        <h2 class="section-title">Add New Stall</h2>
        <form id="stall-form">
          <label for="stall_id">Stall ID (e.g. "tian-tian")</label>
          <input type="text" id="stall_id" required>

          <label for="stall_name">Stall Name</label>
          <input type="text" id="stall_name" required>

          <label for="stall_centre_id">Hawker Centre</label>
          <select id="stall_centre_id" required>
            <option value="">Select a Centre</option>
          </select>

          <label for="cuisine">Cuisine (comma-separated, e.g. Chinese, Noodles)</label>
          <input type="text" id="cuisine">

          <label for="stall_about">About</label>
          <textarea id="stall_about" rows="3"></textarea>

          <label for="photo_urls">Photo URLs (comma-separated)</label>
          <input type="text" id="photo_urls">

          <label for="menu_json">Menu (JSON format)</label>
          <textarea id="menu_json" rows="4" placeholder='[{"name":"Chicken Rice","price":6}]'></textarea>

          <label for="offers_json">Offers (JSON format)</label>
          <textarea id="offers_json" rows="4" placeholder='[{"title":"Free Soup","expiry":"2025-06-30"}]'></textarea>

          <label for="loyalty_milestones">Loyalty Milestones (comma-separated, e.g. 2,5,10)</label>
          <input type="text" id="loyalty_milestones" value="10">

          <button type="submit" style="width: 100%;">Add Stall</button>
        </form>
      </div>

      <div class="card">
        <h2 class="section-title">All Stalls</h2>
        <div id="stalls-list">
          <p>Loading stalls...</p>
        </div>
      </div>
    </div>

    <div class="tab-content" id="reviews-tab">
      <div class="card">
        <h2 class="section-title">All Reviews</h2>
        <div id="reviews-list">
          <p>Loading reviews...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // üëá REPLACE WITH YOUR ADMIN GOOGLE APPS SCRIPT WEB APP URL
    const ADMIN_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwR731pFqExwMWQY_YXGzdBQBk2eqwnN7oWc0l94YOVen_3icpJByxZWvg87eO7HRuk9A/exec';
    const ADMIN_PASSWORD = '@021705d03'; // ‚Üê SET YOUR PASSWORD HERE

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadCentres();
      loadStalls();
      loadReviews();
    });

    // =============== CENTRES ===============
    async function loadCentres() {
      try {
        const response = await fetch(`${ADMIN_SCRIPT_URL}?action=getCentres`);
        const centres = await response.json();
        
        const list = document.getElementById('centres-list');
        if (centres.length === 0) {
          list.innerHTML = '<p>No centres yet.</p>';
          return;
        }

        list.innerHTML = '';
        centres.forEach(centre => {
          const div = document.createElement('div');
          div.className = 'centre-item';
          div.innerHTML = `
            <strong>${centre.name}</strong> (${centre.mrt})<br>
            <small>ID: ${centre.centre_id}</small>
            <button class="delete" onclick="deleteCentre('${centre.centre_id}')">Delete</button>
          `;
          list.appendChild(div);
        });

        const select = document.getElementById('stall_centre_id');
        select.innerHTML = '<option value="">Select a Centre</option>';
        centres.forEach(centre => {
          const option = document.createElement('option');
          option.value = centre.centre_id;
          option.textContent = centre.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading centres:', error);
        document.getElementById('centres-list').innerHTML = '<p>‚ùå Failed to load centres.</p>';
      }
    }

    document.getElementById('centre-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        action: 'addCentre',
        centre_id: document.getElementById('centre_id').value,
        name: document.getElementById('centre_name').value,
        mrt: document.getElementById('mrt').value,
        address: document.getElementById('address').value,
        about: document.getElementById('about').value,
        image_url: document.getElementById('image_url').value,
        password: ADMIN_PASSWORD
      };

      try {
        await fetch(ADMIN_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        alert('‚úÖ Centre added!');
        document.getElementById('centre-form').reset();
        loadCentres();
      } catch (error) {
        alert('‚ùå Failed to add centre.');
        console.error(error);
      }
    });

    async function deleteCentre(centreId) {
      if (!confirm('Delete this centre?')) return;
      try {
        await fetch(ADMIN_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ 
            action: 'deleteCentre', 
            centre_id: centreId,
            password: ADMIN_PASSWORD 
          })
        });
        loadCentres();
      } catch (error) {
        alert('‚ùå Failed to delete centre.');
      }
    }

    // =============== STALLS ===============
    async function loadStalls() {
      try {
        const response = await fetch(`${ADMIN_SCRIPT_URL}?action=getStalls`);
        const stalls = await response.json();
        
        const list = document.getElementById('stalls-list');
        if (stalls.length === 0) {
          list.innerHTML = '<p>No stalls yet.</p>';
          return;
        }

        list.innerHTML = '';
        stalls.forEach(stall => {
          const div = document.createElement('div');
          div.className = 'stall-item';
          div.innerHTML = `
            <strong>${stall.name}</strong><br>
            <small>Centre: ${stall.centre_id} | Cuisine: ${stall.cuisine ? stall.cuisine.join(', ') : ''}</small><br>
            <small>ID: ${stall.stall_id}</small>
            <button class="delete" onclick="deleteStall('${stall.stall_id}')">Delete</button>
          `;
          list.appendChild(div);
        });
      } catch (error) {
        console.error('Error loading stalls:', error);
        document.getElementById('stalls-list').innerHTML = '<p>‚ùå Failed to load stalls.</p>';
      }
    }

    document.getElementById('stall-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        action: 'addStall',
        stall_id: document.getElementById('stall_id').value,
        name: document.getElementById('stall_name').value,
        centre_id: document.getElementById('stall_centre_id').value,
        cuisine: document.getElementById('cuisine').value.split(',').map(s => s.trim()).filter(s => s),
        about: document.getElementById('stall_about').value,
        photo_urls: document.getElementById('photo_urls').value.split(',').map(s => s.trim()).filter(s => s),
        menu_json: document.getElementById('menu_json').value,
        offers_json: document.getElementById('offers_json').value,
        loyalty_milestones: document.getElementById('loyalty_milestones').value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n)),
        password: ADMIN_PASSWORD
      };

      try {
        await fetch(ADMIN_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        alert('‚úÖ Stall added!');
        document.getElementById('stall-form').reset();
        loadStalls();
      } catch (error) {
        alert('‚ùå Failed to add stall.');
        console.error(error);
      }
    });

    async function deleteStall(stallId) {
      if (!confirm('Delete this stall?')) return;
      try {
        await fetch(ADMIN_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ 
            action: 'deleteStall', 
            stall_id: stallId,
            password: ADMIN_PASSWORD 
          })
        });
        loadStalls();
      } catch (error) {
        alert('‚ùå Failed to delete stall.');
      }
    }

    // =============== REVIEWS ===============
    async function loadReviews() {
      try {
        const response = await fetch(`${ADMIN_SCRIPT_URL}?action=getReviews`);
        const reviews = await response.json();
        
        const list = document.getElementById('reviews-list');
        if (reviews.length === 0) {
          list.innerHTML = '<p>No reviews yet.</p>';
          return;
        }

        list.innerHTML = '';
        reviews.forEach(review => {
          const div = document.createElement('div');
          div.className = 'stall-item';
          const date = new Date(review.timestamp);
          div.innerHTML = `
            <strong>${review.stallName}</strong> - ${review.rating}‚òÖ<br>
            <em>"${review.comment}"</em><br>
            <small>Queue: ${review.queueTime} | ${date.toLocaleDateString()}</small><br>
            <button class="delete" onclick="deleteReview('${review.id}')">Delete</button>
          `;
          list.appendChild(div);
        });
      } catch (error) {
        console.error('Error loading reviews:', error);
        document.getElementById('reviews-list').innerHTML = '<p>‚ùå Failed to load reviews.</p>';
      }
    }

    async function deleteReview(reviewId) {
      if (!confirm('Delete this review?')) return;
      try {
        await fetch(ADMIN_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ 
            action: 'deleteReview', 
            review_id: reviewId,
            password: ADMIN_PASSWORD 
          })
        });
        loadReviews();
      } catch (error) {
        alert('‚ùå Failed to delete review.');
      }
    }
  </script>
  
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(function(error) {
            console.log('ServiceWorker registration failed: ', error);
          });
      });
    }
    
    // Handle PWA install prompt
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      // Show install button (if you want)
      showInstallButton();
    });
    
    function showInstallButton() {
      // Create install button if needed
      const installBtn = document.createElement('button');
      installBtn.id = 'install-button';
      installBtn.textContent = 'Install App';
      installBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--accent);
        color: var(--text-primary);
        border: none;
        padding: 12px 24px;
        border-radius: 30px;
        font-weight: 600;
        cursor: pointer;
        z-index: 1000;
        display: none;
      `;
      installBtn.onclick = installApp;
      document.body.appendChild(installBtn);
    }
    
    async function installApp() {
      if (!deferredPrompt) {
        return;
      }
      
      // Show the install prompt
      deferredPrompt.prompt();
      
      // Wait for the user to respond to the prompt
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('User accepted the install prompt');
      } else {
        console.log('User dismissed the install prompt');
      }
      
      // Clear the deferredPrompt variable
      deferredPrompt = null;
    }
    
    // Show install button if app is not already installed
    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      const installBtn = document.getElementById('install-button');
      if (installBtn) {
        installBtn.style.display = 'none';
      }
    });
  </script>
</body>
</html>